# BPF学习之性能分析

# 1. 概览  
# 1.1.目标  
性能分析前我们需要先明确目标,有的放矢.明确了目标后,进一步的分析工作就有了上下文,不至于跑偏.  
一般来说,性能分析的目标是改进用户最终体验和降低运行成本.  
有了目标,最好能将其进行量化:这种量化能够表明是否已经达到优化的目标,还可以定义离目标的差距有多远.  

可测量的指标:  
+ 延迟: 多久可以完成一次请求操作,通常以毫秒为单位.
+ 速率: 每秒操作或请求的速率.
+ 吞吐量: 通常指每秒传输的数据量,以比特(bit)或者字节(byte)为单位.
+ 利用率: 以百分比形式表示的某资源在一段时间内的繁忙程度.
+ 成本: 开销/性能的比例.  

## 1.1.1 改进用户体验　　
最终用户眼中的性能,是端到端的"迟延".这个过程可能由许多组件构成,我们需要细化分析每个组件的开销.由于同时对多个组件跟踪
会带来显著的性能损失.因此在实践中,通常用小而专的工具来研究特定组件的时间开销和延迟.  

## 1.1.2 降低运行成本  
需要观测软件和硬件资源是如何使用的,从中定位可优化的部分,目标是降低公司在云和数据中心方面的开支.  

# 1.2 分析工作  
BPF性能分析工具,不只用于分析特定类型的问题.还可以考虑如何使用它们改进监控、非回归测试，以及其它性能分析活动.  

|  性能分析活动   | BPF性能分析工具  |
|  ----  | ----  |
| 1.原型软件或硬件的性能特征分析  | 测量不同业务负载下的延迟直方图 |
| 2.在开发阶段、集成阶段之前的性能分析  | 解决性能瓶颈点,寻找一般的性能改进点 |
| 3.针对软件的某个版本，在发布前/后进行的非回归测试  | 从多个不同来源记录代码的使用和延迟数据,支持快速定位回归测试问题.|
| 4.基准测试,为软件发布的市场宣传工作提供数据支撑| 解决性能瓶颈点,寻找一般的性能改进点 |
| 5.在目标环境下进行的概念验证测试  | 生成延迟分布直方图,确保性能满足请求的服务等级(SLA) |
| 6.监控生产环境中运行的软件| 编写可以7*24小时运行的工具　,提供新的、之前属于盲区的性能指标|
| 7.故障排查时的性能分析| 使用现成的工具或根据需要创建自定义的观测点来解决特定的性能问题 |

# 1.3 多重性能问题  
识别出哪个性能问题才是最主要的.

# 2.性能分析方法论  
指导从哪里开始,中间步骤有哪些和到哪里结束.

# 2.1 业务负载画像  
业务负载画像的目的是理解实际运行的业务负载.  

**推荐步骤**:
+ 负载是谁产生的(比如,进程ID,用户ID,进程名,IP地址)
+ 负载为什么会产生的(代码路径、调用栈、火焰图)
+ 负载的组成是什么(IPOS、吞吐量、负载类型)
+ 负载怎么随着时间变化(比较每个周期的摘要信息)

# 2.2 下钻分析  
从一个指标开始,然后将这个指标拆分成多个组成部分,再将最大的组件进一步拆分为更小的组件,不断重复这个过程直到定位出
一个或多个根因.  

**推荐步骤**:  
+ 从业务最高层开始分析
+ 检查下一个层级的细节　
+ 挑出最感兴趣的部分或者线索
+ 如果问题还没有解决,跳到步骤2

# 2.3 USE方法论  
针对资源的使用情况进行分析.针对每一个资源,分别去检查:
+ 使用率
+ 饱和度
+ 错误

# 2.4 检查清单法(checklist)
列出一系列工具和指标,用于对照运行和检查.

# 3 Linux 60秒分析  
+ uptime  
+ dmesg | tail
+ vmstat 1
+ mpstat -P ALL 1
+ pidstat 1
+ iostat -xz 1
+ free -m
+ sar -n DEV 1
+ sar -n TCP,ETCP 1
+ top

# 4 BCC工具检查清单  
+ execsnoop
+ opensnoop
+ ex4slower
+ biolantency
+ biosnoop
+ cachestat
+ tcpconnect
+ tcpaccept
+ tcpretrans
+ runqlat
+ profile
